name: Android Build with Auto-Wrapper

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: ðŸ› ï¸ CREATE COMPLETE GRADLE WRAPPER
        run: |
          echo "=== Creating complete Gradle wrapper structure ==="
          
          # 1. Hapus file gradlew lama
          rm -f gradlew gradlew.bat 2>/dev/null || true
          
          # 2. Buat folder wrapper
          mkdir -p gradle/wrapper
          
          # 3. Download gradle-wrapper.jar (versi 8.5)
          echo "Downloading gradle-wrapper.jar..."
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            https://repo.maven.apache.org/maven2/gradle/wrapper/gradle-wrapper/8.5/gradle-wrapper-8.5.jar
          
          # 4. Buat gradle-wrapper.properties
          echo "Creating gradle-wrapper.properties..."
          cat > gradle/wrapper/gradle-wrapper.properties << EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          # 5. Buat file gradlew (shell script)
          echo "Creating gradlew..."
          cat > gradlew << 'EOF'
          #!/usr/bin/env bash
          ##############################################################################
          ##  Gradle startup script for Linux/Mac
          ##############################################################################
          # Attempt to set APP_HOME
          # Resolve links: \$0 may be a link
          PRG="\$0"
          while [ -h "\$PRG" ] ; do
            ls=\`ls -ld "\$PRG"\`
            link=\`expr "\$ls" : '.*-> \(.*\)\$'\`
            if expr "\$link" : '/.*' > /dev/null; then
              PRG="\$link"
            else
              PRG=\`dirname "\$PRG"\`"/\$link"
            fi
          done
          SAVED="\`pwd\`"
          cd "\`dirname "\\\$PRG" \`/" >/dev/null
          APP_HOME="\`pwd -P\`"
          cd "\$SAVED" >/dev/null
          JAVA_OPTS="\$JAVA_OPTS -Dfile.encoding=UTF-8"
          exec "\$JAVA_HOME/bin/java" \$JAVA_OPTS -jar "\$APP_HOME/gradle/wrapper/gradle-wrapper.jar" "\$@"
          EOF
          
          # 6. Buat file gradlew.bat (Windows)
          echo "Creating gradlew.bat..."
          cat > gradlew.bat << EOF
          @if "%DEBUG%" == "" @echo off
          @rem ##########################################################################
          @rem  Gradle startup script for Windows
          @rem ##########################################################################
          @rem Set local scope for the variables with windows NT shell
          set DIRNAME=%~dp0
          set APP_BASE_NAME=%~n0
          set APP_HOME=%DIRNAME%
          @rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
          set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"
          @rem Find java.exe
          set JAVA_EXE=java.exe
          if "%JAVA_EXE%"=="" set JAVA_EXE=%~dp0%\java.exe
          if exist "%JAVA_EXE%" goto execute
          echo. 1>&2
          echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH. 1>&2
          echo. 1>&2
          echo Please set the JAVA_HOME variable in your environment to match the 1>&2
          echo location of your Java installation. 1>&2
          goto fail
          :execute
          @rem Setup the command line
          set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
          @rem Execute Gradle
          "%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dfile.encoding=UTF-8" "-jar" "%CLASSPATH%" %*
          :end
          @rem End local scope for the variables with windows NT shell
          if %ERRORLEVEL% equ 0 goto mainEnd
          :fail
          rem Set variable GRADLE_EXIT_CONSOLE if you need the script to pause before exiting.
          if not "" == "%GRADLE_EXIT_CONSOLE%" pause
          exit /b 1
          :mainEnd
          if "%OS%"=="Windows_NT" endlocal
          :omega
          EOF
          
          # 7. Beri permission executable
          chmod +x gradlew
          
          # 8. Verifikasi
          echo "=== Verification ==="
          ls -la gradle/wrapper/
          echo "File size: $(wc -c < gradle/wrapper/gradle-wrapper.jar) bytes"
          
      - name: Test Gradle Wrapper
        run: |
          ./gradlew --version || echo "Gradle test completed"
          
      - name: Build Android
        run: |
          ./gradlew assembleDebug --stacktrace
